<div class="layui-tab layui-tab-brief">
	<ul class="layui-tab-title site-demo-title">
		<li class="layui-this detail-page"></li>
	</ul>
	<div class="main-content"></div>
</div>


<script id="client-tpl" type="text/html">
<div class="layui-form-item">
    <div class="layui-input-inline">
        <input type="text" name="searchKey"  autocomplete="off" placeholder="" class="layui-input">
    </div>
    <div class="layui-form-mid"><a id="search" class="layui-btn layui-btn-mini search">搜索</a></div>
</div>
<table class="layui-table" lay-skin="line">
    <thead>
        <tr>
            <th class="th-client-name"><%:=$.i18n.prop('client.name')%></th>
            <th class="th-client-key"><%:=$.i18n.prop('client.key')%></th>
            <th class="th-status"><%:=$.i18n.prop('client.code')%></th>
            <th class="th-status"><%:=$.i18n.prop('client.status')%></th>
            <th class="th-status"><%:=$.i18n.prop('client.ip')%></th>
            <th class="th-status"><%:=$.i18n.prop('client.out.remark')%></th>
            <th class="th-status"><%:=$.i18n.prop('client.update.remark')%></th>
        </tr>
    </thead>
    <tbody>
    <%for(var i = 0; i < data.length; i++) {%>
        <tr>
            <td><%:=data[i].name%></td>
            <td><%:=data[i].clientKey%></td>
            <td><%:=data[i].inputCode%></td>
            <td>
                <% if(data[i].status == 1){ %>
                <span class="layui-badge layui-bg-green"><%:=$.i18n.prop('client.status.online')%></span>
                <% } else { %>
                <span class="layui-badge layui-bg-gray"><%:=$.i18n.prop('client.status.offline')%></span>
                <% }%>
            </td>
            <td><%:=data[i].clientIp%></td>
            <td><%:=data[i].remark%></td>
            <td> <a class="layui-btn layui-btn-mini mapping-edit" onclick="showRemark('<%:=data[i].clientKey%>','<%:=data[i].remark%>')"><%:=$.i18n.prop('client.update.edit')%></a></td>
        </tr>
    <%}%>
    </tbody>
</table>
<script>
    $(".layui-this.detail-page").html($.i18n.prop('client.status.offline.list'));
	window.clientList = [];
    $(".search").click(function() {
        var searchKey = $("input[name='searchKey']").val();
        api_invoke("/search", {key:searchKey}, function(data) {
            if (data.code == 20000) {
                clientList = data.data;
			    var html = template($("#client-tpl").html(), data);
			    $(".main-content").html(html);
            } else {
                alert(data.message);
            }
        });
    });

</script>
</script>

<script>

	api_invoke("/config/detail/off", {}, function(data) {
		if (data.code == 20000) {
			clientList = data.data;
			var html = template($("#client-tpl").html(), data);
			$(".main-content").html(html);
			$(".mapping-config").click(function() {
		        window.clientIndex = $(this).attr("data-index");
		        load_page("html/lan/list.html");
			});
			$(".client-edit").click(function() {
				window.clientIndex = $(this).attr("data-index");
				load_page("html/client/edit.html");
			});
			$(".client-delete").click(function() {
				window.clientIndex = $(this).attr("data-index");
				layer.confirm($.i18n.prop('public.confirm.delete'), {
			        title: $.i18n.prop('public.tips'),
		            btn : [ $.i18n.prop('public.ok'), $.i18n.prop('public.cancel') ]
		        }, function(i) {
					layer.close(i);
					clientList.splice(clientIndex, 1);
					api_invoke("/config/update", clientList, function(data) {
						if (data.code != 20000) {
							layer.alert(data.message);
						} else {
	                         location.reload();
						}
					})
				});
			});
		} else {
			alert(data.message);
		}
	});

   function showRemark(sig, def) {
        var input = prompt("备注", def);
        if (input.length > 300) {
            alert("输入太多了");
            return;
        }
        api_invoke("/config/detail/remark", {sig:sig, remark:input}, function(data) {
		if (data.code == 20000) {
			load_page("html/client/list-off.html");
		} else {
			alert(data.message);
		}
	});
   }

</script>


